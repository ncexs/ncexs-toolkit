name: ğŸ§° ncexs Toolkit â€“ Beta 1 Analyzer

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  analyze-and-fix-beta1:
    name: ğŸ” Analyze & Auto-Fix ncexs Toolkit v2.3 Beta 1
    runs-on: windows-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§© Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
          Import-Module PSScriptAnalyzer

      - name: ğŸ” Run static analysis
        id: analyze
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path . -Recurse -Severity Warning,Error
          if ($results) {
            $results | ConvertTo-Json -Depth 5 | Out-File PSScriptAnalyzer-results.json
            $warnings = ($results | Where-Object { $_.Severity -eq "Warning" }).Count
            $errors = ($results | Where-Object { $_.Severity -eq "Error" }).Count
            echo "warnings=$warnings" >> $env:GITHUB_OUTPUT
            echo "errors=$errors" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "âœ… No issues found by PSScriptAnalyzer"
            echo "warnings=0" >> $env:GITHUB_OUTPUT
            echo "errors=0" >> $env:GITHUB_OUTPUT
          }

      - name: ğŸ› ï¸ Auto-fix basic style issues
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path . -Filter "*.ps1" -Recurse
          foreach ($file in $files) {
            Write-Host "âœ¨ Formatting $($file.FullName)"
            try {
              Invoke-Formatter -ScriptDefinition (Get-Content $file.FullName -Raw) |
                Out-File -Encoding utf8 $file.FullName
            } catch {
              Write-Warning "Failed to auto-fix $($file.FullName)"
            }
          }

      - name: ğŸ§¾ Configure Git
        run: |
          git config user.name "ncexs-bot"
          git config user.email "actions@github.com"

      - name: ğŸª„ Create auto-fix branch
        run: |
          git checkout -b autofix/v2.3-beta1

      - name: ğŸ’¾ Commit auto-fix changes
        run: |
          git add .
          git commit -m "ğŸ”§ Auto-fix PowerShell style & formatting (v2.3 Beta 1)" || echo "No changes to commit"

      - name: ğŸš€ Push auto-fix branch
        run: |
          git push origin autofix/v2.3-beta1 || echo "No changes pushed"

      - name: ğŸ“ Update CHANGELOG.md
        shell: pwsh
        run: |
          $changelog = @"
## ğŸ§° ncexs Toolkit â€“ v2.3 Beta 1

### âœ¨ Added
- ğŸ§© New Versioning System via GitHub Actions (CI/CD integration)
- âš™ï¸ Automatic Release Packaging â€“ auto ZIP creation with embedded version tag
- ğŸ’¡ Improved PowerShell 7+ compatibility and stability

### ğŸ”§ Bug Fixes
- Fixed minor path detection inconsistencies
- Adjusted startup check for smoother initialization
- Improved variable handling to prevent duplicate entries

### âš¡ Performance
- Slightly faster initialization on Windows 10/11
- Reduced memory usage on script runtime
"@
          if (Test-Path CHANGELOG.md) {
            $changelog + "`n`n" + (Get-Content CHANGELOG.md -Raw) | Set-Content CHANGELOG.md
          } else {
            $changelog | Out-File CHANGELOG.md
          }
          git add CHANGELOG.md
          git commit -m "ğŸ“ Add CHANGELOG for v2.3 Beta 1" || echo "No changelog changes"

      - name: ğŸ” Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: autofix/v2.3-beta1
          title: "ğŸ”§ Auto-fix ncexs Toolkit v2.3 Beta 1"
          body: |
            This PR includes automatic fixes and changelog for **ncexs Toolkit v2.3 Beta 1**.
            Generated via PowerShell Analyzer workflow.
          commit-message: "Auto-fix PowerShell style issues (v2.3 Beta 1)"
          labels: ["autofix", "beta", "v2.3"]
          reviewers: ["ncexs"]

      # ğŸ§  Post analysis summary to PR
      - name: ğŸ’¬ Post Summary Comment
        if: steps.pr.outputs.pull-request-number
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: summary
          number: ${{ steps.pr.outputs.pull-request-number }}
          message: |
            ## ğŸ§© PowerShell Analyzer Summary â€“ v2.3 Beta 1
            - **Warnings:** ${{ steps.analyze.outputs.warnings }}
            - **Errors:** ${{ steps.analyze.outputs.errors }}
            - **Auto-fix branch:** `autofix/v2.3-beta1`
            - ğŸ“ [View Full Report (PSScriptAnalyzer-results.json)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ---
            _Generated automatically by ncexs-bot_
